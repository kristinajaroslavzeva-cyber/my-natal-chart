from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from datetime import datetime
import pytz
import swisseph as swe
import os
import random

# --- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ò–ò (GEMINI) ---
try:
    import google.generativeai as genai
    AI_AVAILABLE = True
except ImportError:
    AI_AVAILABLE = False
    print("WARNING: google-generativeai library not found.")

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
current_dir = os.path.dirname(os.path.abspath(__file__))
ephe_path = os.path.join(current_dir, 'ephe')
swe.set_ephe_path(ephe_path)

# !!! –í–°–¢–ê–í–¨ –°–í–û–ô –ö–õ–Æ–ß –°–Æ–î–ê !!!
GEMINI_API_KEY = "AIzaSyAObmU1VR5hRc-bCcbYyfanS_6QQ2vr1ks"  

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏ –ò–ò
if AI_AVAILABLE:
    try:
        genai.configure(api_key=GEMINI_API_KEY)
        model = genai.GenerativeModel('gemini-1.5-flash')
    except Exception as e:
        print(f"AI Config Error: {e}")
        AI_AVAILABLE = False

# --- –ë–ê–ó–ê –ö–†–ê–°–ò–í–´–• –¢–ï–ö–°–¢–û–í (–ó–ê–ü–ê–°–ù–û–ô –ü–õ–ê–ù) ---
# –ï—Å–ª–∏ –ò–ò –Ω–µ –æ—Ç–≤–µ—Ç–∏—Ç, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç —ç—Ç–æ, –∞ –Ω–µ –æ—à–∏–±–∫—É.
zodiac_detailed = {
    "Aries": "**‚ôà –í–∞—à –∑–Ω–∞–∫ ‚Äî –û–≤–µ–Ω**\n\n–í—ã ‚Äî –ø–µ—Ä–≤–æ–ø—Ä–æ—Ö–æ–¥–µ—Ü –ó–æ–¥–∏–∞–∫–∞. –í–∞—à–∞ —ç–Ω–µ—Ä–≥–∏—è –±—å–µ—Ç –∫–ª—é—á–æ–º, –≤—ã –Ω–µ –∂–¥–µ—Ç–µ –ø–µ—Ä–µ–º–µ–Ω, –∞ —Å–æ–∑–¥–∞–µ—Ç–µ –∏—Ö —Å–∞–º–∏. –í—ã —á–µ—Å—Ç–Ω—ã, –ø—Ä—è–º–æ–ª–∏–Ω–µ–π–Ω—ã –∏ –æ–±–ª–∞–¥–∞–µ—Ç–µ –¥–∞—Ä–æ–º –≤–¥–æ—Ö–Ω–æ–≤–ª—è—Ç—å –¥—Ä—É–≥–∏—Ö.\n\n*–°–æ–≤–µ—Ç:* –£—á–∏—Ç–µ—Å—å —Ç–µ—Ä–ø–µ–Ω–∏—é, –∏ –≤—ã —Å–≤–µ—Ä–Ω–µ—Ç–µ –≥–æ—Ä—ã.",
    "Taurus": "**‚ôâ –í–∞—à –∑–Ω–∞–∫ ‚Äî –¢–µ–ª–µ—Ü**\n\n–í—ã ‚Äî –≤–æ–ø–ª–æ—â–µ–Ω–∏–µ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ –∏ –∫—Ä–∞—Å–æ—Ç—ã. –í—ã —É–º–µ–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–æ–º—Ñ–æ—Ä—Ç –∏ –Ω–∞—Å–ª–∞–∂–¥–∞—Ç—å—Å—è –∂–∏–∑–Ω—å—é. –í–∞—à–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ ‚Äî –≤–∞—à–∞ —Å—É–ø–µ—Ä—Å–∏–ª–∞.\n\n*–°–æ–≤–µ—Ç:* –ù–µ –±–æ–π—Ç–µ—Å—å –ø–µ—Ä–µ–º–µ–Ω, –æ–Ω–∏ –ø—Ä–∏–Ω–æ—Å—è—Ç —Ä–æ—Å—Ç.",
    "Gemini": "**‚ôä –í–∞—à –∑–Ω–∞–∫ ‚Äî –ë–ª–∏–∑–Ω–µ—Ü—ã**\n\n–í—ã ‚Äî –≥–µ–Ω–∏–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏. –í–∞—à —É–º –±—ã—Å—Ç—Ä, –∫–∞–∫ –º–æ–ª–Ω–∏—è. –í—ã –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã –∏ —Å–ø–æ—Å–æ–±–Ω—ã –Ω–∞–π—Ç–∏ –æ–±—â–∏–π —è–∑—ã–∫ —Å –∫–µ–º —É–≥–æ–¥–Ω–æ.\n\n*–°–æ–≤–µ—Ç:* –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –æ–¥–Ω–æ–π —Ü–µ–ª–∏.",
    "Cancer": "**‚ôã –í–∞—à –∑–Ω–∞–∫ ‚Äî –†–∞–∫**\n\n–í—ã –æ–±–ª–∞–¥–∞–µ—Ç–µ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–π –∏–Ω—Ç—É–∏—Ü–∏–µ–π –∏ —ç–º–ø–∞—Ç–∏–µ–π. –í—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –ª—é–¥–µ–π –±–µ–∑ —Å–ª–æ–≤. –°–µ–º—å—è –∏ –¥–æ–º ‚Äî –≤–∞—à–∞ –∫—Ä–µ–ø–æ—Å—Ç—å.\n\n*–°–æ–≤–µ—Ç:* –ù–µ –ø—Ä—è—á—å—Ç–µ—Å—å –≤ –ø–∞–Ω—Ü–∏—Ä—å, –º–∏—Ä –ª—é–±–∏—Ç –≤–∞—Å.",
    "Leo": "**‚ôå –í–∞—à –∑–Ω–∞–∫ ‚Äî –õ–µ–≤**\n\n–í—ã —Ä–æ–∂–¥–µ–Ω—ã —Å–∏—è—Ç—å. –í–∞—à–∞ —Ö–∞—Ä–∏–∑–º–∞ –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –ª—é–¥–µ–π, –∞ —â–µ–¥—Ä–æ—Å—Ç—å –Ω–µ –∑–Ω–∞–µ—Ç –≥—Ä–∞–Ω–∏—Ü. –í—ã ‚Äî –ø—Ä–∏—Ä–æ–∂–¥–µ–Ω–Ω—ã–π –ª–∏–¥–µ—Ä.\n\n*–°–æ–≤–µ—Ç:* –ü–æ–º–Ω–∏—Ç–µ, —á—Ç–æ –∏—Å—Ç–∏–Ω–Ω—ã–π –∫–æ—Ä–æ–ª—å —Ç–æ—Ç, –∫—Ç–æ —Å–ª—É–∂–∏—Ç —Å–≤–æ–∏–º –ª—é–¥—è–º.",
    "Virgo": "**‚ôç –í–∞—à –∑–Ω–∞–∫ ‚Äî –î–µ–≤–∞**\n\n–í—ã –≤–∏–¥–∏—Ç–µ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ –≤ –¥–µ—Ç–∞–ª—è—Ö. –í–∞—à –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —É–º –∏ —Ç—Ä—É–¥–æ–ª—é–±–∏–µ —Å–ø–æ—Å–æ–±–Ω—ã —Ä–µ—à–∏—Ç—å –ª—é–±—É—é –∑–∞–¥–∞—á—É.\n\n*–°–æ–≤–µ—Ç:* –ë—É–¥—å—Ç–µ –º—è–≥—á–µ –∫ —Å–µ–±–µ, –≤—ã –∏ —Ç–∞–∫ –ø—Ä–µ–∫—Ä–∞—Å–Ω—ã.",
    "Libra": "**‚ôé –í–∞—à –∑–Ω–∞–∫ ‚Äî –í–µ—Å—ã**\n\n–í—ã ‚Äî –º–∞—Å—Ç–µ—Ä –≥–∞—Ä–º–æ–Ω–∏–∏ –∏ –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏. –í—ã –ø—Ä–∏–Ω–æ—Å–∏—Ç–µ –∫—Ä–∞—Å–æ—Ç—É –≤ —ç—Ç–æ—Ç –º–∏—Ä –∏ —É–º–µ–µ—Ç–µ –º–∏—Ä–∏—Ç—å –≤—Ä–∞–≥–æ–≤.\n\n*–°–æ–≤–µ—Ç:* –£—á–∏—Ç–µ—Å—å –≥–æ–≤–æ—Ä–∏—Ç—å ¬´–Ω–µ—Ç¬ª, –Ω–µ —Ç–µ—Ä—è—è —Å–µ–±—è.",
    "Scorpio": "**‚ôè –í–∞—à –∑–Ω–∞–∫ ‚Äî –°–∫–æ—Ä–ø–∏–æ–Ω**\n\n–í—ã –æ–±–ª–∞–¥–∞–µ—Ç–µ –º–∞–≥–Ω–µ—Ç–∏–∑–º–æ–º –∏ –º–æ—â–Ω–æ–π –≤–æ–ª–µ–π. –í—ã –≤–∏–¥–∏—Ç–µ –ª—é–¥–µ–π –Ω–∞—Å–∫–≤–æ–∑—å –∏ –Ω–µ –±–æ–∏—Ç–µ—Å—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π.\n\n*–°–æ–≤–µ—Ç:* –û—Ç–ø—É—Å—Ç–∏—Ç–µ –æ–±–∏–¥—ã, —ç—Ç–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç –≤–∞—à—É —Å–∏–ª—É.",
    "Sagittarius": "**‚ôê –í–∞—à –∑–Ω–∞–∫ ‚Äî –°—Ç—Ä–µ–ª–µ—Ü**\n\n–í–µ—á–Ω—ã–π –æ–ø—Ç–∏–º–∏—Å—Ç –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫. –í–∞—à–∏ —Å—Ç—Ä–µ–ª—ã –ª–µ—Ç—è—Ç –∫ –∑–≤–µ–∑–¥–∞–º. –í—ã —Ñ–∏–ª–æ—Å–æ—Ñ, —Ä–∞—Å—à–∏—Ä—è—é—â–∏–π –≥–æ—Ä–∏–∑–æ–Ω—Ç—ã.\n\n*–°–æ–≤–µ—Ç:* –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ –∫ –¥–µ—Ç–∞–ª—è–º –ø–æ–¥ –Ω–æ–≥–∞–º–∏.",
    "Capricorn": "**‚ôë –í–∞—à –∑–Ω–∞–∫ ‚Äî –ö–æ–∑–µ—Ä–æ–≥**\n\n–í—ã —Å—Ç—Ä–æ–∏—Ç–µ —Å–≤–æ–µ –±—É–¥—É—â–µ–µ, –∫–∞–∫ –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä. –í–∞—à–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –∏ –∞–º–±–∏—Ü–∏–∏ –≤–µ–¥—É—Ç –≤–∞—Å –∫ –≤–µ—Ä—à–∏–Ω–µ.\n\n*–°–æ–≤–µ—Ç:* –ù–µ –∑–∞–±—ã–≤–∞–π—Ç–µ –æ—Ç–¥—ã—Ö–∞—Ç—å, –≤–µ—Ä—à–∏–Ω–∞ –Ω–∏–∫—É–¥–∞ –Ω–µ –¥–µ–Ω–µ—Ç—Å—è.",
    "Aquarius": "**‚ôí –í–∞—à –∑–Ω–∞–∫ ‚Äî –í–æ–¥–æ–ª–µ–π**\n\n–í—ã ‚Äî –Ω–æ–≤–∞—Ç–æ—Ä –∏ –±—É–Ω—Ç–∞—Ä—å. –í—ã —Ü–µ–Ω–∏—Ç–µ —Å–≤–æ–±–æ–¥—É –∏ —Å–º–æ—Ç—Ä–∏—Ç–µ –≤ –±—É–¥—É—â–µ–µ. –í–∞—à–∞ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤–æ—Å—Ö–∏—â–∞–µ—Ç.\n\n*–°–æ–≤–µ—Ç:* –°–æ–µ–¥–∏–Ω–∏—Ç–µ —Å–≤–æ–π –≥–µ–Ω–∏–∞–ª—å–Ω—ã–π —É–º —Å —Ç–µ–ø–ª–æ–º —Å–µ—Ä–¥—Ü–∞.",
    "Pisces": "**‚ôì –í–∞—à –∑–Ω–∞–∫ ‚Äî –†—ã–±—ã**\n\n–í—ã –∂–∏–≤–µ—Ç–µ –≤ –º–∏—Ä–µ –∏–Ω—Ç—É–∏—Ü–∏–∏ –∏ –≥—Ä–µ–∑. –í–∞—à–∞ –¥—É—à–∞ –≥–ª—É–±–æ–∫–∞ –∏ –ø–æ–ª–Ω–∞ —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏—è. –í—ã ‚Äî —Ç–≤–æ—Ä–µ—Ü.\n\n*–°–æ–≤–µ—Ç:* –ù–µ —É–ª–µ—Ç–∞–π—Ç–µ —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –≤ –º–µ—á—Ç—ã, –≤–æ–ø–ª–æ—â–∞–π—Ç–µ –∏—Ö –∑–¥–µ—Å—å."
}

# –ó–∞–≥–æ—Ç–æ–≤–∫–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –≥–æ—Ä–æ—Å–∫–æ–ø–∞ (–µ—Å–ª–∏ –ò–ò –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)
daily_intros = ["–ó–≤–µ–∑–¥—ã —Å–µ–≥–æ–¥–Ω—è –±–ª–∞–≥–æ–≤–æ–ª—è—Ç —Å–º–µ–ª—ã–º.", "–î–µ–Ω—å –ø–æ–ª–æ–Ω —Å–∫—Ä—ã—Ç—ã—Ö —Å–º—ã—Å–ª–æ–≤.", "–ü—Ä–∏—Å–ª—É—à–∞–π—Ç–µ—Å—å –∫ –∏–Ω—Ç—É–∏—Ü–∏–∏."]
daily_love = ["–í –ª—é–±–≤–∏ –≤–æ–∑–º–æ–∂–µ–Ω –ø—Ä–∏—è—Ç–Ω—ã–π —Å—é—Ä–ø—Ä–∏–∑.", "–ì–∞—Ä–º–æ–Ω–∏—è –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö –≤—ã–π–¥–µ—Ç –Ω–∞ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å.", "–ë—É–¥—å—Ç–µ –æ—Ç–∫—Ä—ã—Ç—ã —á—É–≤—Å—Ç–≤–∞–º."]
daily_career = ["–ù–∞ —Ä–∞–±–æ—Ç–µ –≤–∞—à–∏ —É—Å–∏–ª–∏—è –∑–∞–º–µ—Ç—è—Ç.", "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã —Ä–µ—à–∞—Ç—Å—è —É–¥–∞—á–Ω–æ.", "–•–æ—Ä–æ—à–∏–π –º–æ–º–µ–Ω—Ç –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è."]

class BirthData(BaseModel):
    birthDateTime: str
    latitude: float
    longitude: float
    zoneId: str

def get_sign(longitude):
    signs = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", 
             "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"]
    idx = int(longitude / 30)
    return signs[idx % 12]

# --- 1. –ù–ê–¢–ê–õ–¨–ù–ê–Ø –ö–ê–†–¢–ê (–†–ê–°–ß–ï–¢) ---
@app.post("/calculate")
async def calculate_chart(data: BirthData):
    try:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
        local_dt = datetime.fromisoformat(data.birthDateTime)
        try:
            tz = pytz.timezone(data.zoneId)
            if local_dt.tzinfo is None: local_dt = tz.localize(local_dt)
        except: local_dt = local_dt.replace(tzinfo=pytz.UTC)
        
        utc_dt = local_dt.astimezone(pytz.utc)
        julian_day = swe.julday(utc_dt.year, utc_dt.month, utc_dt.day, 
                                utc_dt.hour + utc_dt.minute/60.0 + utc_dt.second/3600.0)

        # –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ (–§–∞–π–ª—ã –∏–ª–∏ –§–æ—Ä–º—É–ª—ã)
        calc_flag = swe.FLG_SWIEPH | swe.FLG_SPEED
        try: swe.calc_ut(julian_day, swe.SUN, calc_flag)
        except swe.Error: calc_flag = swe.FLG_MOSEPH | swe.FLG_SPEED

        # –ü–ª–∞–Ω–µ—Ç—ã
        bodies = {
            "Sun": swe.SUN, "Moon": swe.MOON, "Mercury": swe.MERCURY, 
            "Venus": swe.VENUS, "Mars": swe.MARS, "Jupiter": swe.JUPITER, 
            "Saturn": swe.SATURN, "Uranus": swe.URANUS, "Neptune": swe.NEPTUNE, 
            "Pluto": swe.PLUTO, "Chiron": swe.CHIRON, 
            "True Node": swe.TRUE_NODE, "Lilith": swe.MEAN_APOG
        }

        planets_result = []
        for name, pid in bodies.items():
            try:
                res = swe.calc_ut(julian_day, pid, calc_flag)
                coords = res[0]
                if not coords: continue
                lon = coords[0]
                speed = coords[3] if len(coords) >= 4 else 0.0
                planets_result.append({
                    "name": name, "eclipticLongitude": lon,
                    "sign": get_sign(lon), "signDegree": lon % 30,
                    "isRetrograde": speed < 0
                })
            except: continue

        # –î–æ–º–∞
        try:
            cusps, ascmc = swe.houses(julian_day, data.latitude, data.longitude, b'P')
            houses_result = []
            if len(cusps) >= 13:
                for i in range(1, 13):
                    houses_result.append({
                        "houseNumber": i, "eclipticLongitude": cusps[i],
                        "sign": get_sign(cusps[i]), "signDegree": cusps[i] % 30
                    })
            asc = ascmc[0] if ascmc else 0.0
            mc = ascmc[1] if ascmc and len(ascmc) > 1 else 0.0
            angles = {"Ascendant": asc, "MC": mc}
        except:
             houses_result = []
             angles = {"Ascendant": 0.0, "MC": 0.0}

        return {"planets": planets_result, "houses": houses_result, "angles": angles}
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# --- 2. –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø (–° –ò–ò –ò–õ–ò –ë–ï–ó) ---
@app.post("/interpret")
async def interpret(request: dict):
    try:
        chart = request.get('chart', request)
        planets = chart.get('planets', [])
        
        # –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ò–ò
        prompt_data = ""
        sun_sign = "Unknown"
        for p in planets:
            prompt_data += f"{p['name']} –≤ –∑–Ω–∞–∫–µ {p['sign']}\n"
            if p.get('name') == 'Sun': sun_sign = p.get('sign')

        # 1. –ü–†–û–ë–£–ï–ú –ò–ò
        if AI_AVAILABLE and len(GEMINI_API_KEY) > 20:
            try:
                full_prompt = (
                    f"–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –í–æ—Ç –∫–∞—Ä—Ç–∞ –∫–ª–∏–µ–Ω—Ç–∞:\n{prompt_data}\n"
                    "–ù–∞–ø–∏—à–∏ –≥–ª—É–±–æ–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç. –û–ø–∏—à–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –∏ –∫–∞—Ä–º–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏. "
                    "–ò—Å–ø–æ–ª—å–∑—É–π Markdown (–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç, –∑–∞–≥–æ–ª–æ–≤–∫–∏). –¢–æ–Ω: –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–π, –º–∏—Å—Ç–∏—á–µ—Å–∫–∏–π."
                )
                response = model.generate_content(full_prompt)
                if response.text: return response.text
            except Exception as e:
                print(f"AI Error: {e}")

        # 2. –ó–ê–ü–ê–°–ù–û–ô –í–ê–†–ò–ê–ù–¢ (–ï—Å–ª–∏ –ò–ò –Ω–µ —Å–º–æ–≥)
        return zodiac_detailed.get(sun_sign, f"–í–∞—à–µ –°–æ–ª–Ω—Ü–µ –≤ –∑–Ω–∞–∫–µ {sun_sign}. (–î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ç—Ä–µ–±—É–µ—Ç –ò–ò)")
    except Exception as e:
        return f"–û—à–∏–±–∫–∞: {str(e)}"

# --- 3. –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô –ì–û–†–û–°–ö–û–ü –ù–ê –î–ï–ù–¨ ---
@app.post("/personal_horoscope")
async def personal(request: dict):
    # –ï—Å–ª–∏ –µ—Å—Ç—å –ò–ò - –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑
    if AI_AVAILABLE and len(GEMINI_API_KEY) > 20:
        try:
            prompt = "–ù–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–∏–π, –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. –†–∞–∑–¥–µ–ª–∏ –Ω–∞: –û–±—â–µ–µ, –õ—é–±–æ–≤—å, –ö–∞—Ä—å–µ—Ä–∞."
            response = model.generate_content(prompt)
            if response.text: return response.text
        except: pass
    
    # –ï—Å–ª–∏ –ò–ò –Ω–µ—Ç - —Å–æ–±–∏—Ä–∞–µ–º –∏–∑ –∫—É—Å–æ—á–∫–æ–≤ (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö')
    return (
        f"### üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è\n\n"
        f"**‚ú® –ù–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ:** {random.choice(daily_intros)}\n\n"
        f"**‚ù§Ô∏è –õ—é–±–æ–≤—å:** {random.choice(daily_love)}\n\n"
        f"**üíº –†–∞–±–æ—Ç–∞:** {random.choice(daily_career)}\n\n"
        f"*–°–æ–≤–µ—Ç –¥–Ω—è: –î–æ–≤–µ—Ä—è–π—Ç–µ —Å–µ–±–µ.*"
    )

# --- 4. –°–ò–ù–ê–°–¢–†–ò–Ø (–°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨) ---
@app.post("/synastry")
async def synastry(request: dict):
    # –ï—Å–ª–∏ –µ—Å—Ç—å –ò–ò - –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –µ–≥–æ —Å—Ä–∞–≤–Ω–∏—Ç—å –¥–≤–µ –∫–∞—Ä—Ç—ã (–≤ –±—É–¥—É—â–µ–º)
    # –ü–æ–∫–∞ –≤–µ—Ä–Ω–µ–º –∫—Ä–∞—Å–∏–≤—É—é –∑–∞–≥–ª—É—à–∫—É
    return (
        "### ‚ù§Ô∏è –ê–Ω–∞–ª–∏–∑ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏\n\n"
        "**–≠–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π –±–∞–ª–∞–Ω—Å:**\n–í—ã –æ—Ç–ª–∏—á–Ω–æ –¥–æ–ø–æ–ª–Ω—è–µ—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥–∞. –¢–∞–º, –≥–¥–µ –æ–¥–∏–Ω –∏–º–ø—É–ª—å—Å–∏–≤–µ–Ω, –¥—Ä—É–≥–æ–π –¥–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å.\n\n"
        "**–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Å–≤—è–∑—å:**\n–ú–µ–∂–¥—É –≤–∞–º–∏ –µ—Å—Ç—å –≥–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ. –í—ã —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞.\n\n"
        "**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**\n–£—á–∏—Ç–µ—Å—å –∏—Å–∫–∞—Ç—å –∫–æ–º–ø—Ä–æ–º–∏—Å—Å—ã –∏ —á–∞—â–µ –≥–æ–≤–æ—Ä–∏—Ç–µ –æ —á—É–≤—Å—Ç–≤–∞—Ö."
    )

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=10000)
