from fastapi import FastAPI, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from datetime import datetime
import pytz
import swisseph as swe
import os
import random

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ò (GEMINI) ---
try:
    import google.generativeai as genai
    AI_AVAILABLE = True
except ImportError:
    AI_AVAILABLE = False
    print("WARNING: google-generativeai library not found.")

app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- –ù–ê–°–¢–†–û–ô–ö–ò –ü–£–¢–ï–ô ---
current_dir = os.path.dirname(os.path.abspath(__file__))
ephe_path = os.path.join(current_dir, 'ephe')
swe.set_ephe_path(ephe_path)

# --- –¢–í–û–ô –ö–õ–Æ–ß API ---
GEMINI_API_KEY = "AIzaSyAObmU1VR5hRc-bCcbYyfanS_6QQ2vr1ks"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–æ–¥–µ–ª–∏
if AI_AVAILABLE:
    try:
        genai.configure(api_key=GEMINI_API_KEY)
        model = genai.GenerativeModel('gemini-1.5-flash')
    except Exception as e:
        print(f"AI Config Error: {e}")
        AI_AVAILABLE = False

# --- –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô (–î–õ–ò–ù–ù–´–ï –ö–†–ê–°–ò–í–´–ï –¢–ï–ö–°–¢–´ - –ó–ê–ü–ê–°–ù–û–ô –í–ê–†–ò–ê–ù–¢) ---
zodiac_detailed = {
    "Aries": "**‚ôà –û–í–ï–ù: –ü–µ—Ä–≤–æ–ø—Ä–æ—Ö–æ–¥–µ—Ü**\n\n–í—ã ‚Äî –∏—Å–∫—Ä–∞, –∏–∑ –∫–æ—Ç–æ—Ä–æ–π —Ä–∞–∑–≥–æ—Ä–∞–µ—Ç—Å—è –ø–ª–∞–º—è. –í–∞—à–∞ —ç–Ω–µ—Ä–≥–∏—è –±–µ–∑–≥—Ä–∞–Ω–∏—á–Ω–∞, –∞ –≤–æ–ª—è —Å–ø–æ—Å–æ–±–Ω–∞ –ø—Ä–æ–±–∏—Ç—å –ª—é–±—ã–µ —Å—Ç–µ–Ω—ã. –í—ã –Ω–µ –∂–¥–µ—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞ ‚Äî –≤—ã —Å–æ–∑–¥–∞–µ—Ç–µ –µ–≥–æ —Å–∞–º–∏.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –°–º–µ–ª–æ—Å—Ç—å, –ª–∏–¥–µ—Ä—Å—Ç–≤–æ, —á–µ—Å—Ç–Ω–æ—Å—Ç—å.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –ù–∞—É—á–∏—Ç—å—Å—è —Ç–µ—Ä–ø–µ–Ω–∏—é –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –≥–Ω–µ–≤–æ–º.",
    "Taurus": "**‚ôâ –¢–ï–õ–ï–¶: –°–æ–∑–∏–¥–∞—Ç–µ–ª—å**\n\n–í—ã ‚Äî —Å–∫–∞–ª–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏. –í—ã —É–º–µ–µ—Ç–µ –≤–∏–¥–µ—Ç—å –∫—Ä–∞—Å–æ—Ç—É –≤ –º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω–æ–º –º–∏—Ä–µ –∏ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤–æ–∫—Ä—É–≥ —Å–µ–±—è –∫–æ–º—Ñ–æ—Ä—Ç. –í–∞—à–µ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –ø–æ–¥–æ–±–Ω–æ —Å–∫–∞–ª–µ.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –£–ø–æ—Ä—Å—Ç–≤–æ, –ø—Ä–∞–∫—Ç–∏—á–Ω–æ—Å—Ç—å, –≤–µ—Ä–Ω–æ—Å—Ç—å.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –ü—Ä–µ–æ–¥–æ–ª–µ—Ç—å —Å—Ç—Ä–∞—Ö –ø–µ—Ä–µ–º–µ–Ω.",
    "Gemini": "**‚ôä –ë–õ–ò–ó–ù–ï–¶–´: –ö–æ–º–º—É–Ω–∏–∫–∞—Ç–æ—Ä**\n\n–í–∞—à —Ä–∞–∑—É–º —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–µ–µ –º–æ–ª–Ω–∏–∏. –í—ã ‚Äî –≤–µ—á–Ω—ã–π —É—á–µ–Ω–∏–∫ –í—Å–µ–ª–µ–Ω–Ω–æ–π, –ª–µ–≥–∫–∏–π –Ω–∞ –ø–æ–¥—ä–µ–º –∏ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç, –≥–∏–±–∫–æ—Å—Ç—å, –æ—Å—Ç—Ä–æ—É–º–∏–µ.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –û–±—Ä–µ—Å—Ç–∏ –≥–ª—É–±–∏–Ω—É –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é.",
    "Cancer": "**‚ôã –†–ê–ö: –•—Ä–∞–Ω–∏—Ç–µ–ª—å**\n\n–í—ã –∂–∏–≤–µ—Ç–µ —Å–µ—Ä–¥—Ü–µ–º. –í–∞—à–∞ –¥—É—à–∞ ‚Äî –≥–ª—É–±–æ–∫–∏–π –æ–∫–µ–∞–Ω —ç–º–ø–∞—Ç–∏–∏. –°–µ–º—å—è –∏ –¥–æ–º –¥–ª—è –≤–∞—Å ‚Äî —Å–∞–º–∞—è –≥–ª–∞–≤–Ω–∞—è –∫—Ä–µ–ø–æ—Å—Ç—å –≤ –º–∏—Ä–µ.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –ó–∞–±–æ—Ç–∞, –º–æ—â–Ω–∞—è –∏–Ω—Ç—É–∏—Ü–∏—è, —ç–º–ø–∞—Ç–∏—è.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –ù–∞—É—á–∏—Ç—å—Å—è –æ—Ç–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ—à–ª–æ–µ.",
    "Leo": "**‚ôå –õ–ï–í: –ö–æ—Ä–æ–ª—å**\n\n–í—ã —Ä–æ–∂–¥–µ–Ω—ã, —á—Ç–æ–±—ã —Å–∏—è—Ç—å. –í–∞—à–∞ —Ö–∞—Ä–∏–∑–º–∞ –ø—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –ª—é–¥–µ–π, –∫–∞–∫ –º–∞–≥–Ω–∏—Ç. –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ –∏ –ª—é–±–æ–≤—å ‚Äî –≤–∞—à–∞ —Å—Ç–∏—Ö–∏—è.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å, —â–µ–¥—Ä–æ—Å—Ç—å, –±–ª–∞–≥–æ—Ä–æ–¥—Å—Ç–≤–æ.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –ü–æ–±–µ–¥–∏—Ç—å –≥–æ—Ä–¥—ã–Ω—é –∏ —Å–ª—É–∂–∏—Ç—å –¥—Ä—É–≥–∏–º.",
    "Virgo": "**‚ôç –î–ï–í–ê: –ê–Ω–∞–ª–∏—Ç–∏–∫**\n\n–í—ã –≤–∏–¥–∏—Ç–µ —Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ –≤ –¥–µ—Ç–∞–ª—è—Ö. –í–∞—à –æ—Å—Ç—Ä—ã–π —É–º –∏ —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –ø–æ—Ä—è–¥–∫—É –¥–µ–ª–∞—é—Ç —ç—Ç–æ—Ç –º–∏—Ä –ª—É—á—à–µ –∏ —á–∏—â–µ.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –¢—Ä—É–¥–æ–ª—é–±–∏–µ, –ª–æ–≥–∏–∫–∞, —Å–∫—Ä–æ–º–Ω–æ—Å—Ç—å.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –ü–µ—Ä–µ—Å—Ç–∞—Ç—å –∫—Ä–∏—Ç–∏–∫–æ–≤–∞—Ç—å —Å–µ–±—è –∏ –ø—Ä–∏–Ω—è—Ç—å –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω—Å—Ç–≤–æ –º–∏—Ä–∞.",
    "Libra": "**‚ôé –í–ï–°–´: –î–∏–ø–ª–æ–º–∞—Ç**\n\n–í–∞—à–∞ –º–∏—Å—Å–∏—è ‚Äî –≥–∞—Ä–º–æ–Ω–∏—è. –í—ã –º–∞—Å—Ç–µ—Ä –∫–æ–º–ø—Ä–æ–º–∏—Å—Å–æ–≤ –∏ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∫—Ä–∞—Å–æ—Ç—ã. –í—ã –Ω–µ –º—ã—Å–ª–∏—Ç–µ —Å–µ–±—è –±–µ–∑ –ø–∞—Ä—Ç–Ω–µ—Ä–∞.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –í–∫—É—Å, —Ç–∞–∫—Ç, —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ—Å—Ç—å.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –û–±—Ä–µ—Å—Ç–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å—Ç–µ—Ä–∂–µ–Ω—å –∏ –Ω–∞—É—á–∏—Ç—å—Å—è –≥–æ–≤–æ—Ä–∏—Ç—å ¬´–Ω–µ—Ç¬ª.",
    "Scorpio": "**‚ôè –°–ö–û–†–ü–ò–û–ù: –ú–∏—Å—Ç–∏–∫**\n\n–í—ã –æ–±–ª–∞–¥–∞–µ—Ç–µ —Å–∞–º–æ–π –º–æ—â–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π –≤ –ó–æ–¥–∏–∞–∫–µ. –í–∞—à –≤–∑–≥–ª—è–¥ –ø—Ä–æ–Ω–∏–∫–∞–µ—Ç –≤ –¥—É—à—É. –í—ã –Ω–µ –±–æ–∏—Ç–µ—Å—å –∫—Ä–∏–∑–∏—Å–æ–≤, –≤–µ–¥—å –æ–Ω–∏ –¥–µ–ª–∞—é—Ç –≤–∞—Å —Å–∏–ª—å–Ω–µ–µ.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –í–æ–ª—è, –º–∞–≥–Ω–µ—Ç–∏–∑–º, –∏–Ω—Ç—É–∏—Ü–∏—è.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ–±–∏–¥—ã –≤ –º—É–¥—Ä–æ—Å—Ç—å.",
    "Sagittarius": "**‚ôê –°–¢–†–ï–õ–ï–¶: –§–∏–ª–æ—Å–æ—Ñ**\n\n–í—ã —Ü–µ–ª–∏—Ç–µ—Å—å –≤ –∑–≤–µ–∑–¥—ã. –í–∞—à –æ–ø—Ç–∏–º–∏–∑–º –Ω–µ–∏—Å—Å—è–∫–∞–µ–º, –∞ –∂–∞–∂–¥–∞ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏–π –≤–µ–¥–µ—Ç –≤–∞—Å –∑–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –ú—É–¥—Ä–æ—Å—Ç—å, —ç–Ω—Ç—É–∑–∏–∞–∑–º, —à–∏—Ä–æ—Ç–∞ –≤–∑–≥–ª—è–¥–æ–≤.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –ë—ã—Ç—å –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ –∫ –¥–µ—Ç–∞–ª—è–º –∏ —á—É–≤—Å—Ç–≤–∞–º –¥—Ä—É–≥–∏—Ö.",
    "Capricorn": "**‚ôë –ö–û–ó–ï–†–û–ì: –°—Ç—Ä–∞—Ç–µ–≥**\n\n–í—ã ‚Äî –∞—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä —Å–≤–æ–µ–π —Å—É–¥—å–±—ã. –ü–æ–∫–∞ –¥—Ä—É–≥–∏–µ –º–µ—á—Ç–∞—é—Ç, –≤—ã —Å—Ç—Ä–æ–∏—Ç–µ. –í–∞—à–∞ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ –≤—ã–∑—ã–≤–∞–µ—Ç —É–≤–∞–∂–µ–Ω–∏–µ.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –ê–º–±–∏—Ü–∏–∏, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, —Ç–µ—Ä–ø–µ–Ω–∏–µ.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –û—Ç–∫—Ä—ã—Ç—å —Å–µ—Ä–¥—Ü–µ –∏ –ø–æ–∑–≤–æ–ª–∏—Ç—å —Å–µ–±–µ —ç–º–æ—Ü–∏–∏.",
    "Aquarius": "**‚ôí –í–û–î–û–õ–ï–ô: –ù–æ–≤–∞—Ç–æ—Ä**\n\n–í—ã ‚Äî –≥–æ—Å—Ç—å –∏–∑ –±—É–¥—É—â–µ–≥–æ. –°–≤–æ–±–æ–¥–∞ –¥–ª—è –≤–∞—Å –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ. –í—ã –º—ã—Å–ª–∏—Ç–µ –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ –∏ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –º–∏—Ä.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ—Å—Ç—å, –¥—Ä—É–∂–µ–ª—é–±–∏–µ, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –°–æ–µ–¥–∏–Ω–∏—Ç—å –≥–µ–Ω–∏–∞–ª—å–Ω—ã–π —É–º —Å —Ç–µ–ø–ª–æ–º —Å–µ—Ä–¥—Ü–∞.",
    "Pisces": "**‚ôì –†–´–ë–´: –ú–µ—á—Ç–∞—Ç–µ–ª—å**\n\n–í—ã –∂–∏–≤–µ—Ç–µ –≤ –º–∏—Ä–µ –∏–Ω—Ç—É–∏—Ü–∏–∏ –∏ –≥—Ä–µ–∑. –í–∞—à–∞ –¥—É—à–∞ —Ç–æ–Ω–∫–∞ –∏ –ø–æ–ª–Ω–∞ —Å–æ—Å—Ç—Ä–∞–¥–∞–Ω–∏—è –∫–æ –≤—Å–µ–º—É –∂–∏–≤–æ–º—É.\n\n*–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:* –§–∞–Ω—Ç–∞–∑–∏—è, –¥—É—Ö–æ–≤–Ω–æ—Å—Ç—å, –º–∏–ª–æ—Å–µ—Ä–¥–∏–µ.\n*–ö–∞—Ä–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–∞—á–∞:* –ù–µ —Ç–µ—Ä—è—Ç—å —Å–≤—è–∑—å —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é."
}

class BirthData(BaseModel):
    birthDateTime: str
    latitude: float
    longitude: float
    zoneId: str

def get_sign(longitude):
    signs = ["Aries", "Taurus", "Gemini", "Cancer", "Leo", "Virgo", 
             "Libra", "Scorpio", "Sagittarius", "Capricorn", "Aquarius", "Pisces"]
    idx = int(longitude / 30)
    return signs[idx % 12]

# --- 1. –†–ê–°–ß–ï–¢ –ù–ê–¢–ê–õ–¨–ù–û–ô –ö–ê–†–¢–´ ---
@app.post("/calculate")
async def calculate_chart(data: BirthData):
    try:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏
        local_dt = datetime.fromisoformat(data.birthDateTime)
        try:
            tz = pytz.timezone(data.zoneId)
            if local_dt.tzinfo is None: local_dt = tz.localize(local_dt)
        except: local_dt = local_dt.replace(tzinfo=pytz.UTC)
        
        utc_dt = local_dt.astimezone(pytz.utc)
        julian_day = swe.julday(utc_dt.year, utc_dt.month, utc_dt.day, 
                                utc_dt.hour + utc_dt.minute/60.0 + utc_dt.second/3600.0)

        # –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ (–§–∞–π–ª—ã -> –§–æ—Ä–º—É–ª—ã)
        calc_flag = swe.FLG_SWIEPH | swe.FLG_SPEED
        try: swe.calc_ut(julian_day, swe.SUN, calc_flag)
        except swe.Error: calc_flag = swe.FLG_MOSEPH | swe.FLG_SPEED

        # –ü–ª–∞–Ω–µ—Ç—ã
        bodies = {
            "Sun": swe.SUN, "Moon": swe.MOON, "Mercury": swe.MERCURY, 
            "Venus": swe.VENUS, "Mars": swe.MARS, "Jupiter": swe.JUPITER, 
            "Saturn": swe.SATURN, "Uranus": swe.URANUS, "Neptune": swe.NEPTUNE, 
            "Pluto": swe.PLUTO, "Chiron": swe.CHIRON, 
            "True Node": swe.TRUE_NODE, "Lilith": swe.MEAN_APOG
        }

        planets_result = []
        for name, pid in bodies.items():
            try:
                res = swe.calc_ut(julian_day, pid, calc_flag)
                coords = res[0]
                if not coords: continue
                lon = coords[0]
                # –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—à–∏–±–∫–∏ –∏–Ω–¥–µ–∫—Å–∞
                speed = coords[3] if len(coords) >= 4 else 0.0
                planets_result.append({
                    "name": name, "eclipticLongitude": lon,
                    "sign": get_sign(lon), "signDegree": lon % 30,
                    "isRetrograde": speed < 0
                })
            except: continue

        # –î–æ–º–∞
        try:
            cusps, ascmc = swe.houses(julian_day, data.latitude, data.longitude, b'P')
            houses_result = []
            if len(cusps) >= 13:
                for i in range(1, 13):
                    houses_result.append({
                        "houseNumber": i, "eclipticLongitude": cusps[i],
                        "sign": get_sign(cusps[i]), "signDegree": cusps[i] % 30
                    })
            asc = ascmc[0] if ascmc else 0.0
            mc = ascmc[1] if ascmc and len(ascmc) > 1 else 0.0
            angles = {"Ascendant": asc, "MC": mc}
        except:
             houses_result = []; angles = {"Ascendant": 0.0, "MC": 0.0}

        return {"planets": planets_result, "houses": houses_result, "angles": angles}

    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))

# --- 2. –ò–ù–¢–ï–†–ü–†–ï–¢–ê–¶–ò–Ø (–ò–ò –∏–ª–∏ –ó–∞–ø–∞—Å–Ω–æ–π —Ç–µ–∫—Å—Ç) ---
@app.post("/interpret")
async def interpret(request: dict):
    try:
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        chart = request.get('chart', request)
        planets = chart.get('planets', [])
        sun_sign = "Aries"
        
        prompt_data = ""
        for p in planets:
            if p.get('name') == 'Sun': sun_sign = p.get('sign')
            prompt_data += f"{p['name']} –≤ {p['sign']}; "

        # –í–ê–†–ò–ê–ù–¢ –ê: –°–ü–†–ê–®–ò–í–ê–ï–ú –ò–ò
        if AI_AVAILABLE:
            try:
                full_prompt = (
                    f"–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥. –í–æ—Ç –∫—Ä–∞—Ç–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã: {prompt_data}. "
                    "–ù–∞–ø–∏—à–∏ —è—Ä–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ—Ä—Ç—Ä–µ—Ç –ª–∏—á–Ω–æ—Å—Ç–∏. –ò—Å–ø–æ–ª—å–∑—É–π Markdown (–∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç). "
                    "–°–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â–∏–º."
                )
                response = model.generate_content(full_prompt)
                if response.text:
                    # –í–û–ó–í–†–ê–©–ê–ï–ú JSON!
                    return {"content": response.text}
            except Exception as e:
                print(f"AI Error: {e}")

        # –í–ê–†–ò–ê–ù–¢ –ë: –ó–ê–ü–ê–°–ù–û–ô –¢–ï–ö–°–¢ (–ï—Å–ª–∏ –ò–ò –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª)
        fallback_text = zodiac_detailed.get(sun_sign, "–ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω.")
        # –í–û–ó–í–†–ê–©–ê–ï–ú JSON!
        return {"content": fallback_text}

    except Exception as e:
        return {"content": f"–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: {str(e)}"}

# --- 3. –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ô –ì–û–†–û–°–ö–û–ü (–ò–ò –∏–ª–∏ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä) ---
@app.post("/personal_horoscope")
async def personal(request: dict):
    # –ü–æ–ø—ã—Ç–∫–∞ –ò–ò
    if AI_AVAILABLE:
        try:
            prompt = "–ù–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–∏–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –≥–æ—Ä–æ—Å–∫–æ–ø –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. –†–∞–∑–¥–µ–ª—ã: –û–±—â–µ–µ, –õ—é–±–æ–≤—å, –î–µ–Ω—å–≥–∏."
            response = model.generate_content(prompt)
            if response.text:
                return {"content": response.text}
        except: pass

    # –ó–∞–ø–∞—Å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä
    text = (
        "### üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è (–ó–∞–ø–∞—Å–Ω–æ–π)\n\n"
        "**–û–±—â–µ–µ:** –°–µ–≥–æ–¥–Ω—è –¥–µ–Ω—å –ø–æ–ª–æ–Ω –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π. –°–ª—É—à–∞–π—Ç–µ –∏–Ω—Ç—É–∏—Ü–∏—é.\n"
        "**–õ—é–±–æ–≤—å:** –ì–∞—Ä–º–æ–Ω–∏—è –∏ —Ç–µ–ø–ª–æ –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ö.\n"
        "**–ö–∞—Ä—å–µ—Ä–∞:** –í–∞—à–∏ —É—Å–∏–ª–∏—è –ø—Ä–∏–Ω–µ—Å—É—Ç –ø–ª–æ–¥—ã.\n"
        "*–°–æ–≤–µ—Ç: –í–µ—Ä—å—Ç–µ –≤ —Å–µ–±—è!*"
    )
    return {"content": text}

# --- 4. –°–ò–ù–ê–°–¢–†–ò–Ø (–ò–ò –∏–ª–∏ –ó–∞–≥–ª—É—à–∫–∞) ---
@app.post("/synastry")
async def synastry(request: dict):
    # –ü–æ–ø—ã—Ç–∫–∞ –ò–ò (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –¥–≤—É—Ö –ª—é–¥–µ–π, –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å –ø—Ä–æ–º–ø—Ç)
    if AI_AVAILABLE:
        try:
            prompt = "–ù–∞–ø–∏—à–∏ –∫—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –¥–≤—É—Ö –ª—é–¥–µ–π. –î–∞–π 3 —Å–æ–≤–µ—Ç–∞ –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∏."
            response = model.generate_content(prompt)
            if response.text:
                return {"content": response.text}
        except: pass

    # –ó–∞–ø–∞—Å–Ω–æ–π —Ç–µ–∫—Å—Ç
    text = (
        "### ‚ù§Ô∏è –ê–Ω–∞–ª–∏–∑ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏\n\n"
        "**–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫–∞:** –í—ã –æ—Ç–ª–∏—á–Ω–æ –¥–æ–ø–æ–ª–Ω—è–µ—Ç–µ –¥—Ä—É–≥ –¥—Ä—É–≥–∞.\n"
        "**–≠–º–æ—Ü–∏–∏:** –ú–µ–∂–¥—É –≤–∞–º–∏ –≥–ª—É–±–æ–∫–∞—è —Å–≤—è–∑—å.\n"
        "**–°–æ–≤–µ—Ç:** –£—á–∏—Ç–µ—Å—å —Å–ª—É—à–∞—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞ –∏ –∏—Å–∫–∞—Ç—å –∫–æ–º–ø—Ä–æ–º–∏—Å—Å—ã."
    )
    return {"content": text}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=10000)
